<link rel="stylesheet" th:href="@{/css/my/my.css}">
<link rel="stylesheet" th:href="@{/css/basic.css}">
<header th:replace="layout/main/header.html"></header>
<main style="margin-top: 230px">
  <div id="my">
    <th:block th:replace="layout/my/aside.html"></th:block>
<!--    <main>-->
      <th:block th:replace="layout/my/banner.html"></th:block>
    <section>
      <h3>나의설정</h3>

      <article>
        <form th:action="@{/my/info}" method="post">
          <table border="0" class="myInfo" style="width: 700px;">
<!--            <th:block th:each="cust : ${customer}">-->
              <tr>
                <th>사용자 ID</th>
                <td>
                    <input type="hidden" id="custId" th:value="${#authentication.principal.user.customer.id}">
                  <input type="text" id="uid" class="uid" name="uid" th:value="${cust.memUid}" disabled/>
                </td>
              </tr>
              <tr>
                <th>비밀번호</th>
                <td>
                    <input type="password" placeholder="수정할 비밀번호를 입력해 주세요." name="pass" class="pass"/>
                    <a th:href="@{/my/info}" class="btn modify" data-type="pass">수정하기</a>
                    <span>영문, 숫자, 특수문자 8~12자 설정</span>
                </td>
              </tr>
              <tr>
                <th>이름</th>
                <td>
<!--                  <input type="text" disabled value="홍길동" />-->
                  <input type="text" disabled th:text="${cust.custName}" />
                </td>
              </tr>
              <tr>
                <th>생년월일</th>
                <td>
<!--                  <input type="text" disabled value="1990년 12월 30일" />-->
                  <input type="text" disabled th:value="${cust.custBirth}" />
                </td>
              </tr>
              <tr>
                <th>Email</th>
                <td>
                  <input type="text" name="email1" th:value="${cust.custEmail1}" class="email1"/> @
                  <input type="text" name="email2" th:value="${cust.custEmail2}" class="email2"/>

                   <!-- 이메일 select 시 변경 -->
                  <select onchange="changeDomain()" id="emailDomainSelect">
                    <option value="" selected>직접입력</option> <!-- "직접입력" 이 기본 선택된 상태로 보여짐 -->
                    <option value="gmail.com">gmail.com</option>
                    <option value="naver.com">naver.com</option>
                    <option value="daum.net">daum.net</option>
                  </select><!-- #emailDomainSelect -->
                  <input type="button" class="btn modify" data-type="email" value="수정하기" />
                  <input type="text" name="email1" th:value="${cust.custEmail1}" /> @
                  <input type="text" name="email2" th:value="${cust.custEmail2}" />
                  <select>
                    <option selected>직접입력</option>
                    <option>gmail.com</option>
                    <option>naver.com</option>
                    <option>daum.net</option>
                  </select>
                  <input type="button" class="btn" value="수정하기" />
                </td>
              </tr>
              <tr>
                <th>휴대폰</th>
                <td>
                  <input type="text" th:value="${cust.custHp1}" max="999" class="hp1"/> -
                  <input type="text" th:value="${cust.custHp2}" max="9999" class="hp2"/> -
                  <input type="text" th:value="${cust.custHp3}" max="9999" class="hp3"/>
                  <input type="button" class="btn modify" data-type="hp" value="수정하기" />
                </td>
              </tr>
              <tr>
                <th>주소</th>
                <td>
                  <input name="zip" type="text" placeholder="우편번호" th:value="${cust.custAddr1}" readonly class="addr1"/>
                  <input type="button" value="주소검색" class="btn" /><br />
                  <input name="addr1" class="addr addr2" type="text" placeholder="기본주소" th:value="${cust.custAddr2}" /><br />
                  <input name="addr2" class="addr addr3" type="text" placeholder="상세주소" th:value="${cust.custAddr3}" />
                </td>
              </tr>
              <tr>
                <th>탈퇴</th>
                <td>
                  <input type="button" class="btn quit" value="탈퇴하기" />
                </td>
              </tr>
          </table>
          <p><input type="submit" class="btn submit" value="수정하기" /></p>
        </form>
      </article>
    </section>
  </div>
</main>
<script>
    // 페이지가 로드될 때 이메일 도메인 초기화
    window.onload = function() {
        const email2Input = document.querySelector(".email2");
        const selectedDomain = document.getElementById("emailDomainSelect").value;

        if (selectedDomain) { // 기본값이 있는 경우 설정
            email2Input.value = selectedDomain;
            email2Input.setAttribute("readonly", true);
        }
    };

    document.getElementById("emailDomainSelect").addEventListener("change", function() {
        const emailDomain = this.value;
        const email2Input = document.querySelector(".email2");

        // "직접입력"이 아니면 email2에 값 설정 및 읽기 전용 처리
        if (emailDomain) {
            email2Input.value = emailDomain;
            email2Input.setAttribute("readonly", true);
        } else { // 직접 입력 시 필드를 비우고 입력 가능하게 설정
            email2Input.value = "";
            email2Input.removeAttribute("readonly");
        }
    });

    // 수정 버튼 클릭 시 Fetch 요청 처리
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modify')) {
            e.preventDefault();
            const button = e.target;
            button.disabled = true; // 중복 클릭 방지

            const type = button.dataset.type;
            const jsonData = {
                "custId": document.querySelector('#custId').value,
                "custEmail1": document.querySelector('.email1').value,
                "custEmail2": document.querySelector('.email2').value
            };

            fetch(`/my/info/${type}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(jsonData)
            })
                .then(resp => resp.ok ? resp.json() : Promise.reject("서버 응답 오류"))
                .then(data => alert(data.success ? '이메일이 성공적으로 수정되었습니다.' : '이메일 수정에 실패했습니다.'))
                .catch(err => alert('수정 중 오류가 발생했습니다.'))
                .finally(() => button.disabled = false);
        }
    });
</script>
<footer th:replace="layout/main/footer.html"></footer>
